<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<script type="text/javascript">
	


		var Deferred = function () {
		    var cache = [], value;

			var ref = function (value) {
			    if (value && typeof value.then === "function")
			        return value;
			    return {
			        then: function (callback) {
			            return ref(callback(value));
			        }
			    };
			};

		    return {
		        resolve: function (_value) {
		            if (cache) {
		                value = ref(_value);
		                for (var i = 0, ii = cache.length; i < ii; i++) {
		                	// var callback = function (value) {
		                    //       d.resolve(_callback(value));
		              	    // 	  };
		                    var callback = cache[i]; //取出的是一个在then中封装的callback
		                    value.then(callback);
		                }
		                cache = undefined;
		            }
		        },
		        promise: {
		            then: function (_callback) {
		            	//创建一个新的Deferred对象
		                var d = Deferred();
		                var callback = function (value) { //保存了value的值
		                	var ret = _callback(value);//执行外部的回调，返回结果
		                    d.resolve(ret);
		                };
		                //存入pending容器中
		                if (cache) {
		                    cache.push(callback);
		                } else {
		                    value.then(callback);
		                }
		                //返回新的then接口
		                return d.promise;
		            }
		        }
		    };
		};


		var d = Deferred();

		d.promise.then(function(value){
		    console.log(value); // "step1"
		    return 10 * value;
		}).then(function(value){
		    console.log(value); // 15
		});

		setTimeout(function(){
			d.resolve(100)
		},100)


	</script>
</head>
<body>

</body>
</html>